#!/bin/bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
MARKER='\033[1m[PACKMAN]\033[0m'
cd "$DIR" || exit 1
mkdir -p ~/rpm/

# Detect yum
if command -v yum >/dev/null 2>&1; then
    MODE="yum"
else
    echo -e "$MARKER Could not find yum installed on this machine..."
    exit 1
fi

# Ensure dnf exists for downloading
if ! command -v dnf >/dev/null 2>&1; then
    echo -e "$MARKER Could not find dnf installed on this machine (needed for downloads)."
    exit 1
fi

if [ $# -lt 2 ]; then
    echo "Usage:"
    echo "  packman [search|install|get|uninstall] package"
    echo ""
    echo "  search package:"
    echo "        Display the search result for a package"
    echo ""
    echo "  install packages:"
    echo "        Extracts a given package into the current directory"
    echo ""
    echo "  get packages:"
    echo "        Downloads a given package RPM but doesn't install it"
    echo ""
    echo ""
    echo "  uninstall packages:"
    echo "        Uninstalls a package"
    echo ""
    exit 1
fi

case $1 in
    search)
        shift
        echo -e "$MARKER Searching for: $*"
        yum search "$@"
        ;;
    install)
        shift
        for package in "$@"; do
            echo -e "$MARKER Installing (extracting) $package..."
            cd ~/rpm || exit 1
            dnf download "$package"
            mkdir -p ~/rpm/.packman
            touch ~/rpm/.packman/$package.files
            rpm2cpio *.rpm | cpio -idmv | tee ~/rpm/.packman/$package.files
            cd ..
        done
        ;;

      uninstall)
        shift
        for package in "$@"; do
            FILELIST=~/rpm/.packman/$package.files
            PKGDIR=~/rpm

            if [ ! -f "$FILELIST" ]; then
                echo -e "$MARKER No record of $package being installed."
                continue
            fi

            echo -e "$MARKER Uninstalling $package..."

            # Remove extracted files
            while read -r file; do
                rm -f "$file"
            done < "$FILELIST"

            # Remove RPMs or leftovers related to this package
            rm -f "$PKGDIR"/*"$package"*.rpm

            # Optional: remove empty directories under ~/rpm
            find "$PKGDIR" -type d -empty -delete

            # Remove the filelist record
            rm -f "$FILELIST"

            echo -e "$MARKER $package fully removed."
        done
        ;;


    get)
        shift
        for package in "$@"; do
            echo -e "$MARKER Getting $package..."
            cd rpm || exit 1
            dnf download "$package"
            cd ..
        done
        ;;
    *)
        echo -e "$MARKER Unknown instruction $1"
        ;;
esac
